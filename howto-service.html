

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  
    <title>Implementing a service - Relaynet SDK</title>

    
  

  <link rel="shortcut icon" href="/relaynet-core-js/favicon.ico" type="image/x-icon">

  <link rel="stylesheet" href="/relaynet-core-js/assets/css/just-the-docs.css">

  

  
  <script type="text/javascript" src="/relaynet-core-js/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Implementing a service | Relaynet SDK</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Implementing a service" />
<meta property="og:locale" content="en_US" />
<meta property="og:site_name" content="Relaynet SDK" />
<script type="application/ld+json">
{"@type":"WebPage","url":"/relaynet-core-js/howto-service.html","headline":"Implementing a service","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

</head>

<body>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="link" viewBox="0 0 16 16">
      <title>Link</title>
      <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </symbol>
  </svg>

  <div class="page-wrap">
    <div class="side-bar">
      <div class="site-header">
        <a href="/relaynet-core-js" class="site-title lh-tight">
  Relaynet SDK

</a>
        <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button>
      </div>

      <div class="navigation main-nav js-main-nav">
        <nav role="navigation" aria-label="Main navigation">
  <ul class="navigation-list"><li class="navigation-list-item"><a href="/relaynet-core-js/" class="navigation-list-link">Relaynet SDK</a></li><li class="navigation-list-item active"><a href="/relaynet-core-js/howto-service.html" class="navigation-list-link active">Implementing a service</a></li><li class="navigation-list-item"><a href="/relaynet-core-js/howto-binding.html" class="navigation-list-link">Implementing a binding</a></li><li class="navigation-list-item"><a href="/relaynet-core-js/howto-courier.html" class="navigation-list-link">Implementing a courier</a></li><li class="navigation-list-item"><a href="/relaynet-core-js/howto-gateway.html" class="navigation-list-link">Implementing a gateway</a></li></ul>
</nav>

      </div>
      <footer class="site-footer">
        <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p>
      </footer>
    </div>
    <div class="main-content-wrap js-main-content" tabindex="0">
      <div class="main-content">
        <div class="page-header js-page-header">
          
          
        </div>
        <div class="page">
          
            
          
          <div id="main-content" class="page-content" role="main">
            
              <h1 id="implementing-a-service">
        
        
          <a href="#implementing-a-service" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Implementing a service
        
        
      </h1>

<p>A Relaynet service is a collection of applications that communicate amongst themselves in a centralized or decentralized manner. As a Relaynet app developer, you can use this library to send and receive messages serialized in any format (e.g., JSON, ProtocolBuffers) without being concerned about the underlying transport method(s) (e.g., sneakernet, Tor).</p>

<p>If you’re unfamiliar with the terminology used in Relaynet, you should start by reading the introduction and the concepts sections from the <a href="https://specs.relaynet.link/RS-000">core specification</a> to get a high-level understanding of the technology.</p>
    
      <h2 id="generating-endpoint-key-pair">
        
        
          <a href="#generating-endpoint-key-pair" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Generating endpoint key pair
        
        
      </h2>

<p>Before you’re able to send or receive parcels, you have to initialize your endpoint by generating an RSA key pair with <a href="./api/globals.html#generatersakeypair"><code class="language-plaintext highlighter-rouge">generateRSAKeyPair()</code></a> and getting the public key certified:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span>
  <span class="nx">generateRSAKeyPair</span><span class="p">,</span>
  <span class="nx">issueNodeCertificate</span><span class="p">,</span>
<span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@relaycorp/relaynet-core</span><span class="dl">'</span><span class="p">;</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">initEndpoint</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">privateKey</span><span class="p">,</span> <span class="nx">publicKey</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">generateRSAKeyPair</span><span class="p">();</span>
  <span class="nx">yourFunctionToSecurelyPersistPrivateKey</span><span class="p">(</span><span class="nx">privateKey</span><span class="p">);</span>

  <span class="c1">// Self-signing certificate here, but it can/should be issued by the gateway</span>
  <span class="kd">const</span> <span class="nx">certificate</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">issueNodeCertificate</span><span class="p">({</span>
    <span class="na">issuerPrivateKey</span><span class="p">:</span> <span class="nx">privateKey</span><span class="p">,</span>
    <span class="na">subjectPublicKey</span><span class="p">:</span> <span class="nx">publicKey</span><span class="p">,</span>
  <span class="p">});</span>
  <span class="nx">yourFunctionToShareCertificate</span><span class="p">(</span><span class="nx">certificate</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The private address of your endpoint will be derived from its public key, so depending on the nature of your service you may want to repeat the process above with each endpoint that you communicate with in order to avoid <a href="https://en.wikipedia.org/wiki/Device_fingerprint">fingerprinting</a>.</p>
    
      <h2 id="exchanging-messages">
        
        
          <a href="#exchanging-messages" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Exchanging messages
        
        
      </h2>

<p>As shown in the diagram below, each message between two applications is encapsulated as a parcel, so sending and receiving messages involves serializing and deserializing parcels:</p>

<p><img src="/relaynet-core-js/assets/diagrams/protocol-layers.svg" alt="" /></p>

<p>For example, consider a centralized service whose applications exchange JSON messages such as the one below:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hello world"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>That message could be serialized as a parcel as follows:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Parcel</span><span class="p">,</span> <span class="nx">ServiceMessage</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@relaycorp/relaynet-core</span><span class="dl">'</span><span class="p">;</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">serializeMessage</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">serviceMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ServiceMessage</span><span class="p">(</span>
    <span class="dl">'</span><span class="s1">application/vdn+acme.message+json</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Hello world</span><span class="dl">'</span> <span class="p">})),</span>
  <span class="p">);</span>
  <span class="kd">const</span> <span class="nx">parcel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Parcel</span><span class="p">(</span>
    <span class="dl">'</span><span class="s1">rne+https://acme.com</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">senderCertificate</span><span class="p">,</span>
    <span class="nx">serviceMessage</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span>
  <span class="p">);</span>

  <span class="k">return</span> <span class="k">await</span> <span class="nx">parcel</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">senderPrivateKey</span><span class="p">,</span> <span class="nx">recipientCertificate</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>On the other hand, incoming messages could be deserialized (plus verified and decrypted) as follows:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Parcel</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@relaycorp/relaynet-core</span><span class="dl">'</span><span class="p">;</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">deserializeParcel</span><span class="p">(</span><span class="nx">parcelSerialized</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">parcel</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Parcel</span><span class="p">.</span><span class="nx">deserialize</span><span class="p">(</span><span class="nx">parcelSerialized</span><span class="p">);</span>
  <span class="c1">// At this point the sender's signature has been verified</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Received parcel from</span><span class="dl">'</span><span class="p">,</span> <span class="nx">parcel</span><span class="p">.</span><span class="nx">senderCertificate</span><span class="p">.</span><span class="nx">getCommonName</span><span class="p">());</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">parcel</span><span class="p">.</span><span class="nx">recipient</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">rne+https://acme.com</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Invalid recipient</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">await</span> <span class="nx">parcel</span><span class="p">.</span><span class="nx">unwrapMessage</span><span class="p">(</span><span class="nx">recipientPrivateKey</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
    
      <h3 id="with-the-channel-session-protocol">
        
        
          <a href="#with-the-channel-session-protocol" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> With the Channel Session Protocol
        
        
      </h3>

<p>Where possible, you should use the <a href="https://specs.relaynet.link/RS-003">channel session protocol</a> to exchange messages because that adds perfect forward secrecy, future secrecy and replay attack mitigation. This library hides nearly all the technical details of the protocol, but you’re still responsible for securely persisting and retrieving the ephemeral keys until they expire.</p>

<p>This protocol requires the recipient to generate an ephemeral key pair and share the public component before communication begins, in addition to the longer term key already generated above; e.g.:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span>
  <span class="nx">issueInitialDHKeyCertificate</span><span class="p">,</span>
  <span class="nx">generateECDHKeyPair</span><span class="p">,</span>
<span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@relaycorp/relaynet-core</span><span class="dl">'</span><span class="p">;</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">generateInitialKeyPair</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">privateKey</span><span class="p">,</span> <span class="nx">publicKey</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">generateECDHKeyPair</span><span class="p">();</span>
  <span class="nx">yourFunctionToSecurelyPersistSessionPrivateKey</span><span class="p">(</span><span class="nx">privateKey</span><span class="p">);</span>

  <span class="c1">// Self-signing certificate here, but it can/should be issued by the gateway</span>
  <span class="kd">const</span> <span class="nx">endpointPrivateKey</span> <span class="o">=</span> <span class="nx">yourFunctionToSecurelyRetrievePrivateKey</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">endpointCertificate</span> <span class="o">=</span> <span class="nx">yourFunctionToRetrieveCertificate</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">certificate</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">issueInitialDHKeyCertificate</span><span class="p">({</span>
    <span class="na">issuerPrivateKey</span><span class="p">:</span> <span class="nx">endpointPrivateKey</span><span class="p">,</span>
    <span class="na">issuerCertificate</span><span class="p">:</span> <span class="nx">endpointCertificate</span><span class="p">,</span>
    <span class="na">subjectPublicKey</span><span class="p">:</span> <span class="nx">publicKey</span><span class="p">,</span>
  <span class="p">});</span>
  <span class="nx">yourFunctionToShareInitialCertificate</span><span class="p">(</span><span class="nx">certificate</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then the examples above to serialize and deserialize parcels can be rewritten as follows:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Parcel</span><span class="p">,</span> <span class="nx">ServiceMessage</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@relaycorp/relaynet-core</span><span class="dl">'</span><span class="p">;</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">serializeMessage</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">serviceMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ServiceMessage</span><span class="p">(</span>
    <span class="dl">'</span><span class="s1">application/vdn+acme.message+json</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Hello world</span><span class="dl">'</span> <span class="p">})),</span>
  <span class="p">);</span>
  <span class="kd">const</span> <span class="nx">parcel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Parcel</span><span class="p">(</span>
    <span class="dl">'</span><span class="s1">rne+https://acme.com</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">senderCertificate</span><span class="p">,</span>
    <span class="nx">serviceMessage</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span>
  <span class="p">);</span>

  <span class="kd">const</span> <span class="p">{</span> <span class="nx">serialization</span><span class="p">,</span> <span class="nx">dhPrivateKey</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">parcel</span><span class="p">.</span><span class="nx">serializeWithSession</span><span class="p">(</span>
    <span class="nx">senderPrivateKey</span><span class="p">,</span>
    <span class="nx">recipientDhCertificate</span><span class="p">,</span>
  <span class="p">);</span>
  <span class="nx">yourFunctionToSecurelyPersistSessionPrivateKey</span><span class="p">(</span><span class="nx">dhPrivateKey</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">serialization</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">deserializeParcel</span><span class="p">(</span><span class="nx">parcelSerialized</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">parcel</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Parcel</span><span class="p">.</span><span class="nx">deserialize</span><span class="p">(</span><span class="nx">parcelSerialized</span><span class="p">);</span>
  <span class="c1">// At this point the sender's signature has been verified</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Received parcel from</span><span class="dl">'</span><span class="p">,</span> <span class="nx">parcel</span><span class="p">.</span><span class="nx">senderCertificate</span><span class="p">.</span><span class="nx">getCommonName</span><span class="p">());</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">parcel</span><span class="p">.</span><span class="nx">recipient</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">rne+https://acme.com</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Invalid recipient</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">await</span> <span class="nx">parcel</span><span class="p">.</span><span class="nx">unwrapMessageWithSession</span><span class="p">(</span>
    <span class="nx">recipientDhPrivateKey</span><span class="p">,</span>
    <span class="nx">recipientDhCertificate</span><span class="p">,</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
            

          

          

        </div>
      </div>
    </div>
  </div>

</body>
</html>
